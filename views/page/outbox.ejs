<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Meta tags and title -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/styles/style.css">
  <title>Email System - Outbox</title>
</head>

<%
  function getRecipientFullName(recipientId, users) {
    const recipient = users.find(user => user.id === recipientId);
    return recipient ? recipient.full_name : 'Unknown Sender';
  }
%>

<body>
  <!-- Header section -->
  <header>
    <h1>Welcome, <%= user.full_name %>!</h1>
    <nav>
      <!-- Navigation links -->
      <ul>
        <li><a href="/inbox">Inbox</a></li>
        <li><a href="/compose">Compose</a></li>
        <li><a href="/outbox">Outbox</a></li>
        <li><a href="/signout">Sign Out</a></li>
      </ul>
    </nav>
  </header>

  <!-- Main section -->
  <section class="email-section">
    <h2>Outbox</h2>

    <% if (outboxEmails.length > 0) { %>
    <!-- Display emails and pagination -->
        <% outboxEmails.forEach(email => { %>
          <!-- Email item with checkbox and details -->
          <li class="email-item">
            <input type="checkbox" id="email_<%= email.id %>" name="selectedEmails" value="<%= email.id %>">
              <!-- Email details (sender's name, subject, time received) -->
            <span><%= getRecipientFullName(email.recipient_id, users) %></span>
            <span></span><a href="/emaildetail/<%= email.id %>">
              <p><%= email.subject %></p>
            </a></span>
              <span><%= email.time_sent %></span>
          </li>
        <% }); %>
      </ul>

    <!-- Pagination links -->
    <div class="pagination">
      <% for (let i = 1; i <= totalPages; i++) { %>
      <a href="/outbox?page=<%= i %>"><%= i %></a>
      <% } %>
    </div>

    <!-- Delete button (Advanced Requirement) -->
    <button id="deleteBtn">Delete Selected Emails</button>

    <script>
      // JavaScript for handling delete button click
      document.getElementById('deleteBtn').addEventListener('click', async () => {
        const confirmed = window.confirm('Are you sure you want to delete selected emails?');
        if (confirmed) {
          const selectedEmails = Array.from(document.querySelectorAll('input[name="selectedEmails"]:checked'))
            .map(checkbox => checkbox.value);

          if (selectedEmails.length > 0) {
            const response = await fetch('/api/deleteemails', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                emailIds: selectedEmails
              }),
            });

            if (response.ok) {
              // Remove deleted emails from the current page without reloading
              selectedEmails.forEach(emailId => {
                const emailElement = document.querySelector(`input[value="${emailId}"]`);
                // Assuming the emailElement is the checkbox itself, remove the parent element
                emailElement.parentElement.remove();
              });
            } else {
              console.error('Failed to delete emails');
            }
          }
        }
      });
    </script>
    <% } else { %>
    <!-- Message for empty outbox -->
    <p>No emails in the outbox.</p>
    <% } %>
  </section>
</body>

</html>
